---
title: "GAMUT 2015 Summary Report"
author: ''
date: '`r paste(params$program_name)`'
output:
  pdf_document:
    highlight: tango
    includes:
      in_header: header.tex
    toc: yes
  html_document:
    toc: yes
  fontsize: 11pt
params:
  dag: Akron Childrens
  end_date: '2016-01-01'
  operator: ''
  program_name: Akron Childrens
  start_date: '2015-01-01'
---


```{r initial_setup, echo=FALSE, message=FALSE, warning=FALSE}
library(REDCapR)
library(knitr)
library(plyr)
library(dplyr)
library(magrittr)
library(GAMUT)
library(zoo)
library(beeswarm)


options(scipen = 10)
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, comment = "")


source('beeswarm_plot.R')
source('beeswarm_plot_1k.R')
source('beeswarm_plot_10k.R')


# Shadowtest: adds white around text label
# http://stackoverflow.com/questions/25631216/r-is-there-any-way-to-put-border-shadow-or-buffer-around-text-labels-en-r-plot

shadowtext <- function(x, y=NULL, labels, col='white', bg='black', 
                       theta= seq(0, 2*pi, length.out=50), r=0.1, ... ) {

    xy <- xy.coords(x,y)
    xo <- r*strwidth('A')
    yo <- r*strheight('A')

    # draw background text with small shift in x and y in background colour
    for (i in theta) {
        text( xy$x + cos(i)*xo, xy$y + sin(i)*yo, labels, col=bg, ... )
    }
    # draw actual text in exact xy position in foreground colour
    text(xy$x, xy$y, labels, col=col, ... )
}


```
```{r load_data}
# Uncomment next line to get new data from REDCap
#GAMUT_data("GAMUT.Rdata")
load("GAMUT.Rdata")

# Filter 
monthly_data <- filter(monthly_data,
                       month >= params$start_date & 
                       month < params$end_date)

dag <- params$dag
operator <- params$operator

```

\pagestyle{fancy}
\fancyheadoffset{0cm}
\rhead{}
\lhead{`r dag`}
\chead{GAMUT 2015 Summary Report}
\cfoot{Confidential report for quality improvement purposes}
\fancyfoot[LE,RO]{\thepage}

\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0.4pt}

\thispagestyle{empty}
\begin{center}
%\Large{`r paste(dag, ifelse(operator == "AIM", "Air Methods", ""))`}
\vfill
`r paste("Report generated on ", Sys.Date())`

\end{center}  

```{r introduction, child='introduction.Rmd'}
```


\newpage  

```{r interpreting graphs, child='interpreting.Rmd'}
```

\newpage  

# Advanced Airway Metrics
## Ventilator utilization

```{r vent_adv_airway, fig.height = 2.5, fig.path="figures/", include=TRUE, eval=FALSE, message=FALSE, echo =FALSE, warning=FALSE, error=FALSE}

plotData <- pd(dag=dag, operator = operator,
               num="adv_airway_ventilator",
               den="adv_airway_cases"
               )

beeswarm_plot(plotData,
    "Percent of patient transport contacts with
  an advanced airway supported by a mechanical ventilator"
)

```


```{r neo_vent_adv_airway, fig.height = 2.5, fig.path="figures/", include=TRUE, eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

plotData <- pd(dag=dag, operator = operator,
               num="neo_adv_airway_vent",
               den="neo_adv_airway_cases"
               )

beeswarm_plot(plotData,
    "Percent of Neonatal patient transport contacts with
    an advanced airway supported by a mechanical ventilator"
)

```


```{r ped_vent_adv_airway, fig.height = 2.5, fig.path="figures/", include=TRUE, eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

plotData <- pd(dag=dag, operator = operator,
               num="ped_adv_airway_vent",
               den="ped_adv_airway_cases"
               )

beeswarm_plot(plotData,
    "Percent of Pediatric patient transport contacts with
    an advanced airway supported by a mechanical ventilator"
)

```

```{r adult_vent_adv_airway, fig.height = 2.5, fig.path="figures/", include=TRUE, eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

plotData <- pd(dag=dag, operator = operator,
               num="adult_adv_airway_vent",
               den="adult_adv_airway_cases"
               )
#plotData <- plotData[plotData$den >= 50,]


beeswarm_plot(plotData,
    "Percent of Adult patient transport contacts with
    an advanced airway supported by a mechanical ventilator"
)

```
\newpage  

## Waveform capnography
```{r waveform_capno, include=TRUE, fig.height=3, fig.path="figures/", eval=FALSE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}
plotData <- pd(dag=dag, operator = operator,
               num="adv_airway_wave_capno",
               den="adv_airway_cases"
               )

beeswarm_plot(plotData,
    "Percent of patient transport contacts with advanced airways
 in whom continuous waveform capnography was used."
)
```


```{r neo_waveform_capno, include=TRUE, fig.height=2.5, out.height ="6in", fig.path="figures/", eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

plotData <- pd(dag=dag, operator = operator,
               num="neo_adv_airway_capno",
               den="neo_adv_airway_cases"
               )

beeswarm_plot(plotData,
    "Percent of Neonatal patient transport contacts with advanced airways
 in whom continuous waveform capnography was used."
)

metric.table <- plot_metrics(
    "Percent of Neonatal patient transport contacts with advanced airways
 in whom continuous waveform capnography was used",
                             program_name = plotData$label,
                             num = plotData$num,
                             den = plotData$den,
                             reordering = "increasing",
                             pch = plotData$mark
                             )

#metric.table$plot

```


```{r ped_waveform_capno, include=TRUE,  fig.path="figures/", eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE, fig.height = 2.5, error=FALSE}

plotData <- pd(dag=dag, operator = operator,
               num="ped_adv_airway_capno",
               den="ped_adv_airway_cases"
               )

beeswarm_plot(plotData,
    "Percent of Pediatric patient transport contacts with advanced airways
 in whom continuous waveform capnography was used"
)


```


```{r adult_waveform_capno, include=TRUE,  fig.height = 2.5,fig.path="figures/", eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

plotData <- pd(dag=dag, operator = operator,
               num="adult_adv_airway_capno",
               den="adult_adv_airway_cases"
               )


beeswarm_plot(plotData,
    "Percent of Adult patient transport contacts with advanced airways
 in whom continuous waveform capnography was used"
)

```

\newpage  

## Tracheal tube confirmation
```{r confirmed_tt, include=TRUE, fig.height = 2.5, fig.path="figures/", eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

plotData <- pd(dag=dag, operator = operator,
               num="adv_airway_tt_confirmed",
               den="adv_airway_tt_cases"
               )

beeswarm_plot(plotData,
    "Percent of intubated patient transport contacts
with documentation of confirmed tracheal tube placement."
)
```


## RSI Protocol Compliance  

```{r RSI_compliance, include=TRUE, fig.height=2.5, fig.path="figures/", eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

plotData <- pd(dag=dag, operator = operator,
               num="intub_rsi_compliant",
               den="intub_rsi_cases"
               )

beeswarm_plot(plotData,
    "Percent of patient transport contacts undergoing RSI
where all indicated elements of the program`s RSI protocol were completed."
)
```



\newpage  

# Intubation Metrics
## First Attempt Success

```{r first_attempt_success_neo,  eval=TRUE, fig.height = 2.5, fig.path="figures/", include=TRUE, eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

plotData <- pd(dag=dag, operator = operator,
               num="intub_neo_first_success",
               den="intub_neo_attempts"
               )

beeswarm_plot(plotData,
    "Neonatal - Percent of patient transport contacts successfully intubated
    on the 1st attempt by the transport team"
)

```


```{r first_attempt_success_ped, eval=TRUE, fig.height = 2.5, fig.path="figures/", include=TRUE, eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

plotData <- pd(dag=dag, operator = operator,
               num="intub_ped_first_success",
               den="intub_ped_attempts"
               )

beeswarm_plot(plotData,
    "Pediatric - Percent of patient transport contacts successfully intubated
    on the 1st attempt by the transport team"
)

```


```{r first_attempt_success_adult, eval=TRUE, fig.height = 2.5, fig.path="figures/",  eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

plotData <- pd(dag=dag, operator = operator,
               num="intub_adult_first_success",
               den="intub_adult_attempts"
               )

beeswarm_plot(plotData,
    "Adult - Percent of patient transport contacts successfully intubated
    on the 1st attempt by the transport team"
)

```

\newpage  

## DASH1A 

```{r DASH1A_neo, include=TRUE, fig.height = 2.5,  fig.path="figures/", eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

plotData <- pd(dag=dag, operator = operator,
               num="intub_neo_no_hypoxia",
               den="intub_neo_attempts"
               )

beeswarm_plot(plotData,
    "Neonatal - Percent of patients with definitive airway during the 1st attempt
    by the transport team without suffering hypoxia or hypotension"
)

```

```{r DASH1A_ped, include=TRUE, fig.height = 2.5,  fig.path="figures/", eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

plotData <- pd(dag=dag, operator = operator,
               num="intub_ped_no_hypoxia",
               den="intub_ped_attempts"
               )

beeswarm_plot(plotData,
    "Pediatric - Percent of patients with definitive airway during the 1st attempt
    by the transport team without suffering hypoxia or hypotension"
)


```


```{r DASH1A_adult, include=TRUE, fig.height = 2.5,  fig.path="figures/", eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

plotData <- pd(dag=dag, operator = operator,
               num="intub_adult_no_hypoxia",
               den="intub_adult_attempts"
               )

beeswarm_plot(plotData,
    "Adult - Percent of patients with definitive airway during the 1st attempt
    by the transport team without suffering hypoxia or hypotension"
)

```



\newpage  

# General Transport Metrics
### Pain Assessment
```{r pain_assessment, include=TRUE, fig.height=2.2, fig.path="figures/", eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

plotData <- pd(dag=dag, operator = operator,
               num="pain_scale_used",
               den="total_patients"
               )

beeswarm_plot(plotData,
    "Percent of patient transport contacts with a
documented pain assessment."
)

```

### HEMS Over-triage
```{r hems_over_triage, include=TRUE, fig.height=2.2, fig.path="figures/", eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

plotData <- pd(dag=dag, operator = operator,
               num="hems_ed_discharge",
               den="hems_cases"
               )

beeswarm_plot1k(plotData,
    "Number of HEMS patient transport contacts
discharged without hospital admission per 1000 HEMS transports"
)

```


```{r hems_over_triage_table, results='asis', include=TRUE, fig.height=2.2, fig.path="figures/", eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

HEMS <-
    monthly_data %>%
    select(month, program_name, num=hems_ed_discharge, den=hems_cases) %>%
    filter(!is.na(num),
           !is.na(den),
            den > 0,
            den >= num)

# kable(HEMS)
```

### CPR During transport
```{r cpr, include=TRUE, fig.height=2.2, fig.path="figures/", eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

plotData <- pd(dag=dag, operator = operator,
               num="cpr_cases",
               den="total_patients"
               )

beeswarm_plot10k(plotData,
    "CPR rate per 10,000 transports"
)

```


## Standardized handoffs
```{r handoff_tool, include=TRUE,fig.height=2.5,   fig.path="figures/", eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

plotData <- pd(dag=dag, operator = operator,
               num="standardized_handoffs",
               den="total_patients"
               )

beeswarm_plot(plotData,
    "Percent of cases involving a standardized patient care hand-off"
)

```



## Neonatal Hypothermia

```{r neonatal_hypothermia, fig.height=2.5,  fig.path="figures/", eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

plotData <- pd(dag=dag, operator = operator,
               num="unintended_hypothermia",
               den="total_neo_patients"
               )

beeswarm_plot(plotData,"Percent of neonates found \nhypothermic upon admission"
)

```

\newpage  

# Specific Clinical Metrics

## Blood glucose checks with altered mentation
```{r bg_check, include=TRUE, fig.height=2.5,  fig.path="figures/", eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

plotData <- pd(dag=dag, operator = operator,
               num="alt_ment_bg_checks",
               den="alt_ment_cases"
               )

beeswarm_plot(plotData,
    "Percent of patient transport contacts with altered mental status
    or focal neurologic deficit with a documented blood glucose check"
)

```


```{r bedside_stemi, fig.path="figures/", fig.height=8, eval=FALSE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

bedside_stemi_data <-
    bedside_monthly_data %>%
    #filter(stemi_cases > 0 & mean_bedside_stemi > 0) %>%
    mutate(overall_bedside_stemi = weighted.mean(mean_bedside_stemi, stemi_cases, na.rm = TRUE)) %>%
    mutate(overall_scene_stemi = weighted.mean(mean_scene_stemi, stemi_cases, na.rm = TRUE)) %>%
    group_by(program_name) %>%
    mutate(wm_bedside_stemi = weighted.mean(mean_bedside_stemi, stemi_cases, na.rm = TRUE)) %>%
    mutate(wm_scene_stemi = weighted.mean(mean_scene_stemi, stemi_cases, na.rm = TRUE)) %>%
    group_by(program_name, ID) %>%
    summarize(total_stemi_cases = sum(stemi_cases),
              total_wm_bedside_stemi = round(mean(wm_bedside_stemi),2),
              total_wm_scene_stemi = round(mean(wm_scene_stemi),2),
              overall_bedside_stemi = round(mean(overall_bedside_stemi),2),
              overall_scene_stemi = round(mean(overall_scene_stemi),2)) %>%
    select(program_name:ID, total_stemi_cases, total_wm_bedside_stemi, overall_bedside_stemi,
           total_wm_scene_stemi, overall_scene_stemi)


metric.table <- plot_metrics_wm(
                             program_name = bedside_stemi_data$program_name,
                             wavg = bedside_stemi_data$total_wm_bedside_stemi,
                             rate_overall= bedside_stemi_data$overall_bedside_stemi,
                             num = sum(bedside_stemi_data$total_stemi_cases),
                             reordering="decreasing",
                             qlabel="Weighted average* time in minutes"
                             )
metric.table$main = "Average bedside time for STEMI activation patients"
metric.table

```

```{r scene_stemi, fig.cap="",  fig.path="figures/", fig.height=10, eval=FALSE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

scene_stemi_data <-
    monthly_data %>%
    filter(stemi_cases > 0 & mean_scene_stemi > 0) %>%
    mutate(overall_bedside_stemi = weighted.mean(mean_bedside_stemi, stemi_cases, na.rm = TRUE)) %>%
    mutate(overall_scene_stemi = weighted.mean(mean_scene_stemi, stemi_cases, na.rm = TRUE)) %>%
    group_by(program_name) %>%
    mutate(wm_bedside_stemi = weighted.mean(mean_bedside_stemi, stemi_cases, na.rm = TRUE)) %>%
    mutate(wm_scene_stemi = weighted.mean(mean_scene_stemi, stemi_cases, na.rm = TRUE)) %>%
    group_by(program_name, ID) %>%
    summarize(total_stemi_cases = sum(stemi_cases),
              total_wm_bedside_stemi = round(mean(wm_bedside_stemi),2),
              total_wm_scene_stemi = round(mean(wm_scene_stemi),2),
              overall_bedside_stemi = round(mean(overall_bedside_stemi),2),
              overall_scene_stemi = round(mean(overall_scene_stemi),2)) %>%
    select(program_name:ID, total_stemi_cases, total_wm_bedside_stemi, overall_bedside_stemi,
           total_wm_scene_stemi, overall_scene_stemi)

metric.table <- plot_metrics_wm(
                             program_name = scene_stemi_data$program_name,
                             wavg = scene_stemi_data$total_wm_scene_stemi,
                             rate_overall= scene_stemi_data$overall_scene_stemi,
                             num = sum(scene_stemi_data$total_stemi_cases),
                             reordering="decreasing",
                             qlabel="Weighted average* time in minutes"
                             )
metric.table$main = "Average scene time for STEMI activation patients"
metric.table

```


```{r ecg_stemi, include=TRUE,fig.height=2.5,   fig.path="figures/",  height=4, eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

plotData <- pd(dag=dag, operator = operator,
               num="ecg_accurate_interpret",
               den="ecg_cases"
               )

beeswarm_plot(plotData,
    "Percent of transport patient contacts with accurately
interpreted 12-lead ECG evaluations"
)

```


```{r ecg_stemi_table, results='asis', include=TRUE,  fig.path="figures/", fig.height=4, eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

STEMI <-
    monthly_data %>%
    select(month, program_name, num=ecg_accurate_interpret, den=ecg_cases) %>%
    filter(!is.na(num),
           !is.na(den),
            den > 0,
            den >= num)

#kable(plotData)
```


## Hemorrhagic Stroke
```{r htn_hem_stroke, include=TRUE, fig.height=2.5,  fig.path="figures/", eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

plotData <- pd(dag=dag, operator = operator,
               num="hem_stroke_bp_managed",
               den="hem_stroke_cases"
               )

beeswarm_plot(plotData,
    "Percent of transport patient contacts with
hemorrhagic stroke and appropriate blood pressure management"
)

```

## Hemorrhagic Shock
```{r hem_shock_managed, include=TRUE,fig.height=2.5,   fig.path="figures/", eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

plotData <- pd(dag=dag, operator = operator,
               num="hem_shock_managed",
               den="hem_shock_cases"
               )

beeswarm_plot(plotData,
    "Percent of patient transport contacts with
hemorrhagic shock appropriately managed"
)

```

## Aortic Dissection
```{r bp_aortic, include=TRUE, fig.height=2.5,  fig.path="figures/", eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

plotData <- pd(dag=dag, operator = operator,
               num="aortic_dissect_managed",
               den="aortic_dissect_cases"
               )

beeswarm_plot(plotData,
    "Percent of patient transport contacts with known or suspected
    aortic dissection receiving indicated blood pressure and heart rate therapies"
)

```



\newpage  

# Safety Event Metrics
## Patient injuries
```{r patient_injuries, include=TRUE, fig.height=2.5, fig.path="figures/", eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

plotData <- pd(dag=dag, operator = operator,
               num="patient_injuries",
               den="total_patients"
               )

beeswarm_plot10k(plotData,
    "Patient injuries
    per 10,000 patient transport contacts."
)

```


## Crew injuries
```{r crew_injuries, include=TRUE, fig.height=2.5, fig.path="figures/", eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

plotData <- pd(dag=dag, operator = operator,
               num="crew_injuries",
               den="total_patients"
               )

beeswarm_plot10k(plotData,
    "Crew injuries
    per 10,000 patient transport contacts."
)

```


## Medical equipment failures
```{r med_equip_failure, include=TRUE,fig.height=2.5,  fig.path="figures/", eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

plotData <- pd(dag=dag, operator = operator,
               num="med_equip_failure",
               den="total_patients"
               )

beeswarm_plot1k(plotData,
    "Medical equipment failures
    per 1000 patient transport contacts."
)

```


## Device dislodgement
```{r device_dislogement, include=TRUE,fig.height=2.5,  fig.path="figures/", eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

plotData <- pd(dag=dag, operator = operator,
               num="dislodgements",
               den="total_patients"
               )

beeswarm_plot1k(plotData,
    "Unplanned dislodgements of therapeutic devices
    per 1000 patient transport contacts", 
    plot_scale = 1000
)

```

## Medication errors
```{r med_error, include=TRUE,  fig.height=2.5,fig.path="figures/", eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

plotData <- pd(dag=dag, operator = operator,
               num="medication_errors",
               den="total_patients"
               )

beeswarm_plot10k(plotData,
    "Medication error rate
    per 10,000 patient transport contacts."
)

```

## Serious Reportable Events
```{r sre, include=TRUE, fig.height = 2.5, fig.path="figures/", eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

plotData <- pd(dag=dag, operator = operator,
               num="sre",
               den="total_patients"
               )

beeswarm_plot10k(plotData,
    "SRE rate
    per 10,000 patient transport contacts"
)

```

## Transport-related patient mishaps
```{r nearmiss, include=TRUE, fig.height = 2.5, fig.path="figures/", eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

plotData <- pd(dag=dag, operator = operator,
               num="near_miss",
               den="total_patients"
               )

beeswarm_plot10k(plotData,
    "Transport-related patient mishap rate
    per 10,000 patient transport contacts"
)

```


## Adverse Drug Events
```{r ade, include=TRUE, fig.height=2.5, fig.path="figures/", eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE, error=FALSE}

plotData <- pd(dag=dag, operator = operator,
               num="ade",
               den="total_patients"
               )

beeswarm_plot10k(plotData,
    "Adverse drug events
    per 10,000 patient transport contacts"
)

```
